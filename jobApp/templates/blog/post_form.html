{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Post{% else %}Create New Post{% endif %}
{% endblock %}

{% block content %}
    <style>
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>

    <div class="container mx-auto px-4 py-12 lg:py-16 pt-8 max-w-3xl">
        <div class="bg-white p-8 lg:p-12 rounded-xl card-shadow">
            <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-900 mb-6 text-center">
                {% if form.instance.pk %}
                    Edit Post
                {% else %}
                    Create New Post
                {% endif %}
            </h1>
            <p class="text-center text-gray-600 mb-8">
                Fill out the form below to share your thoughts with the community.
            </p>

            <!-- Legend for required fields -->
            <p class="text-sm text-gray-500 mb-6">
                <span class="text-red-500">*</span> indicates a required field
            </p>

            <form method="post" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <!-- Display Non-Field Errors -->
                {% if form.non_field_errors %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Form Fields with required asterisk -->
                {% for field in form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ field.label }}
                            {% if field.field.required %}
                                <span class="text-red-500">*</span>
                            {% endif %}
                        </label>
                        {% if field.label == 'Category' %}
                        <div class="flex items-center gap-2">
                        {% endif %}

                        {{ field }}
                        
                        {% if field.label == 'Category' %}
                            <button type="button" id="new-category-link" class="text-blue-500 hover:text-blue-700 font-medium whitespace-nowrap text-sm">New Category?</button>
                        </div>
                        {% endif %}

                        <!-- Display Field Errors -->
                        {% for error in field.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endfor %}

                <!-- Action Buttons -->
                <div class="flex flex-col md:flex-row gap-4 mt-8">
                    <button type="submit" class="btn-primary">
                        {% if form.instance.pk %}
                            <i class="fas fa-save mr-2"></i> Update Post
                        {% else %}
                            <i class="fas fa-plus mr-2"></i> Publish Post
                        {% endif %}
                    </button>
                    <a href="{% if form.instance.pk %}{% url 'blog_detail' slug=form.instance.slug %}{% else %}{% url 'blog_list' %}{% endif %}" class="btn-secondary">
                        <i class="fas fa-times-circle mr-2"></i> Cancel
                    </a>

                </div>
            </form>
        </div>
    </div>

    <!-- Category Creation Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm transform transition-transform duration-300 scale-95">
            <div id="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Add New Category</h3>
                    <button type="button" id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="category-form" class="space-y-4">
                    <p class="text-sm text-gray-500">
                        Enter a name for the new category.
                    </p>
                    <div>
                        <label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-1">
                            Category Name
                        </label>
                        <input type="text" id="new-category-name" name="name" class="form-input" required>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="modal-cancel" class="btn-secondary px-4 py-2">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary px-4 py-2">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript for dynamic category creation -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categorySelect = document.getElementById('id_category');
            const newCategoryLink = document.getElementById('new-category-link');
            const categoryModal = document.getElementById('category-modal');
            const categoryForm = document.getElementById('category-form');
            const closeModalBtn = document.getElementById('close-modal');
            const modalCancelBtn = document.getElementById('modal-cancel');
            const newCategoryInput = document.getElementById('new-category-name');
            const modalContent = document.getElementById('modal-content');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            newCategoryLink.addEventListener('click', (e) => {
                e.preventDefault();
                categoryModal.classList.remove('hidden');
                categoryModal.classList.add('flex');
                setTimeout(() => categoryModal.querySelector('div').classList.remove('scale-95'), 10);
            });

            // Close modal functions
            const closeModal = () => {
                categoryModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    categoryModal.classList.add('hidden');
                    // Reset modal content
                    modalContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Add New Category</h3>
                            <button type="button" id="close-modal-reset" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="category-form-reset" class="space-y-4">
                            <p class="text-sm text-gray-500">
                                Enter a name for the new category.
                            </p>
                            <div>
                                <label for="new-category-name-reset" class="block text-sm font-medium text-gray-700 mb-1">
                                    Category Name
                                </label>
                                <input type="text" id="new-category-name-reset" name="name" class="form-input" required>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" id="modal-cancel-reset" class="btn-secondary px-4 py-2">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary px-4 py-2">
                                    Create
                                </button>
                            </div>
                        </form>
                    `;
                    document.getElementById('close-modal-reset').addEventListener('click', closeModal);
                    document.getElementById('modal-cancel-reset').addEventListener('click', closeModal);
                    attachFormSubmitListener();
                }, 300);
            };

            closeModalBtn.addEventListener('click', closeModal);
            modalCancelBtn.addEventListener('click', closeModal);

            const attachFormSubmitListener = () => {
                const form = document.getElementById('category-form') || document.getElementById('category-form-reset');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const categoryName = (document.getElementById('new-category-name') || document.getElementById('new-category-name-reset')).value;

                        if (!categoryName) return;

                        const submitBtn = form.querySelector('[type="submit"]');
                        const originalBtnHtml = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                        try {
                            const response = await fetch('/create-category/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ name: categoryName })
                            });
                            
                            const data = await response.json();

                            if (response.ok && data.status === 'success') {
                                // Add the new category to the dropdown
                                const newOption = document.createElement('option');
                                newOption.value = data.id;
                                newOption.textContent = data.name;
                                categorySelect.appendChild(newOption);
                                categorySelect.value = data.id;

                                // Show success message in modal
                                modalContent.innerHTML = `
                                    <div class="flex flex-col items-center text-center p-4">
                                        <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Success!</h3>
                                        <p class="text-gray-600 mb-4">Category "${data.name}" has been created successfully.</p>
                                        <button type="button" id="close-success-modal" class="btn-primary px-6 py-2">
                                            Got it!
                                        </button>
                                    </div>
                                `;
                                document.getElementById('close-success-modal').addEventListener('click', closeModal);

                            } else {
                                // Handle server-side errors
                                const errorMsg = data.error || 'Unknown error.';
                                modalContent.innerHTML = `
                                    <div class="flex flex-col items-center text-center p-4">
                                        <i class="fas fa-exclamation-circle text-red-500 text-6xl mb-4"></i>
                                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Error!</h3>
                                        <p class="text-gray-600 mb-4">${errorMsg}</p>
                                        <button type="button" id="close-error-modal" class="btn-primary px-6 py-2">
                                            Close
                                        </button>
                                    </div>
                                `;
                                document.getElementById('close-error-modal').addEventListener('click', closeModal);
                                
                            }
                        } catch (error) {
                            console.error('Network or other error:', error);
                            // Handle network errors
                            modalContent.innerHTML = `
                                <div class="flex flex-col items-center text-center p-4">
                                    <i class="fas fa-exclamation-circle text-red-500 text-6xl mb-4"></i>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Error!</h3>
                                    <p class="text-gray-600 mb-4">An unexpected error occurred. Please try again.</p>
                                    <button type="button" id="close-error-modal-catch" class="btn-primary px-6 py-2">
                                        Close
                                    </button>
                                </div>
                            `;
                            document.getElementById('close-error-modal-catch').addEventListener('click', closeModal);
                        }
                    });
                }
            };

            attachFormSubmitListener();
        });
    </script>
{% endblock %}


