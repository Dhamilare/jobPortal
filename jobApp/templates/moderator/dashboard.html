{% extends 'base.html' %}

{% block title %}Dashboard - Remote Ready Jobs{% endblock %}

{% block content %}
    <div class="py-12 px-4 md:px-8 lg:px-16 bg-gray-50 min-h-screen">
        <div class="container mx-auto max-w-7xl">
            
            {# --- Welcome Header --- #}
            <header class="mb-10 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 flex items-center justify-center tracking-tight">
                    <i class="fas fa-user-shield text-indigo-600 mr-4"></i> Dashboard
                </h1>
                <p class="text-xl text-gray-600 mt-2">Welcome back, <span class="text-indigo-700 font-semibold">{{ user.get_full_name|default:user.username }}</span></p>
            </header>

            {% if messages %}
                <div class="mb-8 space-y-4 max-w-4xl mx-auto">
                    {% for message in messages %}
                        {% comment %} Using a more modern, shadowed alert box {% endcomment %}
                        <div class="p-4 rounded-xl shadow-lg flex items-center transition-all duration-300
                            {% if message.tags == 'success' %}bg-white text-green-700 border-l-4 border-green-500 hover:shadow-xl{% endif %}
                            {% if message.tags == 'error' %}bg-white text-red-700 border-l-4 border-red-500 hover:shadow-xl{% endif %}
                            {% if message.tags == 'info' %}bg-white text-blue-700 border-l-4 border-blue-500 hover:shadow-xl{% endif %}
                            {% if message.tags == 'warning' %}bg-white text-yellow-700 border-l-4 border-yellow-500 hover:shadow-xl{% endif %}
                        " role="alert">
                            {% if message.tags == 'success' %}<i class="fas fa-check-circle mr-4 text-2xl flex-shrink-0"></i>{% endif %}
                            {% if message.tags == 'error' %}<i class="fas fa-exclamation-circle mr-4 text-2xl flex-shrink-0"></i>{% endif %}
                            {% if message.tags == 'info' %}<i class="fas fa-info-circle mr-4 text-2xl flex-shrink-0"></i>{% endif %}
                            {% if message.tags == 'warning' %}<i class="fas fa-exclamation-triangle mr-4 text-2xl flex-shrink-0"></i>{% endif %}
                            <div class="font-medium">{{ message }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="space-y-12">
                
                {# --- Stats Cards (Key Metrics) --- #}
                <section>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                                
                        <div class="bg-white rounded-2xl p-6 shadow-xl border-t-4 border-indigo-500 flex items-center transition-transform duration-300 hover:scale-[1.01] hover:shadow-2xl">
                            <div class="p-3 bg-indigo-100 rounded-full mr-4 shadow-inner">
                                <i class="fas fa-briefcase text-indigo-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-medium tracking-wider">Total Jobs</p>
                                <p class="text-3xl font-extrabold text-gray-900">{{ total_jobs }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-xl border-t-4 border-yellow-500 flex items-center transition-transform duration-300 hover:scale-[1.01] hover:shadow-2xl">
                            <div class="p-3 bg-yellow-100 rounded-full mr-4 shadow-inner">
                                <i class="fas fa-users text-yellow-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-medium tracking-wider">Total Applicants</p>
                                <p class="text-3xl font-extrabold text-gray-900">{{ total_applicants }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-xl border-t-4 border-purple-500 flex items-center transition-transform duration-300 hover:scale-[1.01] hover:shadow-2xl">
                            <div class="p-3 bg-purple-100 rounded-full mr-4 shadow-inner">
                                <i class="fas fa-clipboard-list text-purple-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-medium tracking-wider">Applications</p>
                                <p class="text-3xl font-extrabold text-gray-900">{{ applications }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-xl border-t-4 border-green-500 flex items-center transition-transform duration-300 hover:scale-[1.01] hover:shadow-2xl">
                            <div class="p-3 bg-green-100 rounded-full mr-4 shadow-inner">
                                <i class="fas fa-user-check text-green-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-medium tracking-wider">Verified Users</p>
                                <p class="text-3xl font-extrabold text-gray-900">{{ verified_users }}</p>
                            </div>
                        </div>
                        
                    </div>
                </section>

                {# --- Quick Actions --- #}
                <section class="bg-white rounded-2xl p-8 shadow-2xl">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center">
                        <i class="fas fa-rocket text-indigo-500 mr-3"></i> Quick Actions
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                        
                        {% comment %} Action Link Base Style: flex flex-col items-center p-6 rounded-xl border border-transparent transition-all duration-300 hover:border-indigo-300 hover:shadow-lg {% endcomment %}
                        
                        <a href="{% url 'job_list_create' %}" class="flex flex-col items-center p-6 bg-indigo-50 rounded-xl transition-all duration-300 hover:bg-indigo-100 hover:shadow-lg group">
                            <i class="fas fa-plus-circle text-indigo-600 text-4xl mb-3 transition-colors group-hover:text-indigo-700"></i>
                            <span class="text-base font-medium text-indigo-800 text-center">Manage Jobs</span>
                        </a>
                        <a href="{% url 'moderator_reports' %}" class="flex flex-col items-center p-6 bg-yellow-50 rounded-xl transition-all duration-300 hover:bg-yellow-100 hover:shadow-lg group">
                            <i class="fas fa-chart-bar text-yellow-600 text-4xl mb-3 transition-colors group-hover:text-yellow-700"></i>
                            <span class="text-base font-medium text-yellow-800 text-center">View Reports</span>
                        </a>
                        <a href="{% url 'manage_categories' %}" class="flex flex-col items-center p-6 bg-purple-50 rounded-xl transition-all duration-300 hover:bg-purple-100 hover:shadow-lg group">
                            <i class="fas fa-tags text-purple-600 text-4xl mb-3 transition-colors group-hover:text-purple-700"></i>
                            <span class="text-base font-medium text-purple-800 text-center">Manage Categories</span>
                        </a>
                        
                        {% if user.is_staff %}
                            <a href="{% url 'is_staff_create_moderator' %}" class="flex flex-col items-center p-6 bg-green-50 rounded-xl transition-all duration-300 hover:bg-green-100 hover:shadow-lg group">
                                <i class="fas fa-user-plus text-green-600 text-4xl mb-3 transition-colors group-hover:text-green-700"></i>
                                <span class="text-base font-medium text-green-800 text-center">Create Moderator</span>
                            </a>
                            <a href="{% url 'manage_moderators' %}" class="flex flex-col items-center p-6 bg-gray-100 rounded-xl transition-all duration-300 hover:bg-gray-200 hover:shadow-lg group">
                                <i class="fas fa-user-shield text-gray-600 text-4xl mb-3 transition-colors group-hover:text-gray-700"></i>
                                <span class="text-base font-medium text-gray-800 text-center">Manage Moderators</span>
                            </a>
                            <a href="{% url 'is_staff_export_applicants_csv' %}" class="flex flex-col items-center p-6 bg-red-50 rounded-xl transition-all duration-300 hover:bg-red-100 hover:shadow-lg group">
                                <i class="fas fa-file-csv text-red-600 text-4xl mb-3 transition-colors group-hover:text-red-700"></i>
                                <span class="text-base font-medium text-red-800 text-center">Export Data</span>
                            </a>
                        {% endif %}
                    </div>
                </section>
                
                {# --- Main Content: Applications and Activity Log --- #}
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {# --- Job Applications Overview (Updated for Mobile Responsiveness) --- #}
                    <section class="bg-white rounded-2xl p-8 shadow-2xl lg:col-span-2">
                        <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-clipboard-check text-blue-600 mr-3"></i> Active Job Applications
                        </h2>
                        
                        <div id="job-applications-table-container">
                            
                            {% if recent_jobs_with_apps %}
                            
                                {# DESKTOP VIEW: Traditional Table (visible on medium screens and up) #}
                                <div class="hidden md:block overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Job Title & Company</th>
                                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Applications</th>
                                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-100">
                                            {% for job in recent_jobs_with_apps %}
                                            <tr class="hover:bg-blue-50 transition-colors duration-150">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    <i class="far fa-dot-circle text-blue-400 mr-2"></i> {{ job.title }} at <span class="font-normal text-gray-600">{{ job.company_name }}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                                    <span class="px-3 py-1 inline-flex text-sm font-bold rounded-full bg-blue-500 text-white shadow-md">
                                                        {{ job.app_count }}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                                    <a href="{% url 'job_applications_moderator_list' job.slug %}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors inline-flex items-center group">
                                                        <i class="fas fa-eye mr-2 group-hover:scale-110 transition-transform"></i> Review List
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                {# MOBILE VIEW: Stacked Cards (visible on small screens only) #}
                                <div class="md:hidden space-y-4">
                                    {% for job in recent_jobs_with_apps %}
                                    <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-start mb-3">
                                            <h4 class="text-base font-semibold text-gray-900 leading-tight">
                                                {{ job.title }}
                                            </h4>
                                            <span class="px-3 py-1 text-xs font-bold rounded-full bg-blue-500 text-white flex-shrink-0">
                                                {{ job.app_count }} Apps
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3"><i class="fas fa-building mr-1 text-gray-400"></i> {{ job.company_name }}</p>
                                        <div class="text-right">
                                            <a href="{% url 'job_applications_moderator_list' job.slug %}" class="text-sm text-blue-600 hover:text-blue-800 font-medium inline-flex items-center">
                                                <i class="fas fa-arrow-right mr-1"></i> Review
                                            </a>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                {# APPLICATION TABLE PAGINATION (INLINE REPLACEMENT FOR MISSING FILE) #}
            
                                {% if job_app_page_obj.paginator.num_pages > 1 %}
                                <div class="mt-6 flex justify-center items-center space-x-2 text-gray-600">
                                    
                                    {# Previous Page Link #}
                                    {% if job_app_page_obj.has_previous %}
                                        <a href="?job_app_page={{ job_app_page_obj.previous_page_number }}" data-page="{{ job_app_page_obj.previous_page_number }}" class="page-link px-3 py-1 rounded-lg bg-white border border-gray-300 hover:bg-gray-100 transition-colors">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </a>
                                    {% else %}
                                        <span class="px-3 py-1 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </span>
                                    {% endif %}

                                    {# Page Numbers #}
                                    {% for i in job_app_page_obj.paginator.page_range %}
                                        {% if job_app_page_obj.number == i %}
                                            <span class="px-3 py-1 rounded-lg font-bold bg-blue-600 text-white shadow-md">{{ i }}</span>
                                        {% elif i > job_app_page_obj.number|add:'-2' and i < job_app_page_obj.number|add:'2' %}
                                            <a href="?job_app_page={{ i }}" data-page="{{ i }}" class="page-link px-3 py-1 rounded-lg bg-white border border-gray-300 hover:bg-gray-100 transition-colors">{{ i }}</a>
                                        {% endif %}
                                    {% endfor %}

                                    {# Next Page Link #}
                                    {% if job_app_page_obj.has_next %}
                                        <a href="?job_app_page={{ job_app_page_obj.next_page_number }}" data-page="{{ job_app_page_obj.next_page_number }}" class="page-link px-3 py-1 rounded-lg bg-white border border-gray-300 hover:bg-gray-100 transition-colors">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </a>
                                    {% else %}
                                        <span class="px-3 py-1 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                            {% else %}
                                <p class="px-6 py-8 text-center text-gray-500 italic border border-dashed rounded-lg">
                                    <i class="fas fa-briefcase-slash mr-2"></i> No active jobs with applications to display.
                                </p>
                            {% endif %}
                            
                        </div>
                    </section>
                    
                    {# --- Recent Activity Log --- #}
                    <section class="bg-white rounded-2xl p-8 shadow-2xl lg:col-span-1">
                        <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-history text-purple-600 mr-3"></i> Recent Activity Log
                        </h2>
                        <ul class="space-y-5">
                            {% if recent_activity_log %}
                                {% for activity in recent_activity_log|slice:":5" %} {# Limiting to 5 for clean sidebar view #}
                                    <li class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        {% if activity.type == 'job_created' %}
                                            <i class="fas fa-plus-square text-green-500 mr-4 mt-1 text-xl flex-shrink-0"></i>
                                        {% elif activity.type == 'applicant_registered' %}
                                            <i class="fas fa-user-plus text-indigo-500 mr-4 mt-1 text-xl flex-shrink-0"></i>
                                        {% elif activity.type == 'job_applied' %}
                                            <i class="fas fa-file-alt text-yellow-500 mr-4 mt-1 text-xl flex-shrink-0"></i>
                                        {% else %}
                                            <i class="fas fa-info-circle text-gray-500 mr-4 mt-1 text-xl flex-shrink-0"></i>
                                        {% endif %}
                                        <div class="flex-grow">
                                            <p class="text-gray-800 font-medium leading-snug">{{ activity.message }}</p>
                                            <span class="text-xs text-gray-500 block mt-1">{{ activity.timestamp|timesince }} ago</span>
                                        </div>
                                    </li>
                                {% endfor %}
                            {% else %}
                                <p class="text-center text-gray-500 flex items-center justify-center p-6 border border-dashed rounded-lg">
                                    <i class="fas fa-info-circle mr-2"></i> No recent activity to display.
                                </p>
                            {% endif %}
                        </ul>
                    </section>
                </div>
                
                {# --- Subscribers List (Staff Only) --- #}
                {% if user.is_staff %}
                <section class="bg-white rounded-2xl p-8 shadow-2xl" id="subscribers-list">
                    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-8">
                        <div class="flex items-center mb-4 lg:mb-0">
                            <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center mr-4 shadow-md">
                                <i class="fas fa-envelope-open-text text-3xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-900">Courses Subscribers</h2>
                        </div>

                        <div class="relative w-full lg:w-96">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Search by email..."
                                value="{{ query }}"
                                class="w-full p-3 pl-12 pr-12 rounded-xl border border-gray-300 focus:outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all shadow-sm"
                            >
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <i id="clear-search" class="fas fa-times-circle absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors {% if not query %}hidden{% endif %}"></i>
                        </div>
                    </div>

                    <div id="subscribers-table-container">
                        {% comment %} Include the partial for dynamic loading (subscribers_table.html still required) {% endcomment %}
                        {% include 'staff/subscribers_table.html' %}
                    </div>
                </section>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        // --- Shared Pagination/AJAX Helper Function ---
        function attachPaginationListeners(containerId, handler) {
            const container = document.getElementById(containerId);
            if (container) {
                container.querySelectorAll('.page-link').forEach(link => {
                    link.removeEventListener('click', handler); // Prevent double-binding
                    link.addEventListener('click', handler);
                });
            }
        }
        
        // --- Subscriber List Pagination/Search Logic ---

        function fetchSubscribers(page = 1, query = '') {
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            url.searchParams.set('q', query);

            fetch(url.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const newContent = tempDiv.querySelector('#subscribers-table-container').innerHTML;

                const oldContainer = document.getElementById('subscribers-table-container');

                if (oldContainer) {
                    oldContainer.innerHTML = newContent;
                    
                    // Re-attach event listeners for the new content
                    attachPaginationListeners('subscribers-table-container', handleSubscriberPaginationClick);
                }
            })
            .catch(error => console.error('Error fetching subscribers:', error));
        }

        function handleSubscriberPaginationClick(event) {
            event.preventDefault();
            let targetElement = event.target.closest('.page-link');
            if (!targetElement) return;

            const page = targetElement.dataset.page;
            const query = searchInput.value;
            fetchSubscribers(page, query);

            const subscribersSection = document.getElementById('subscribers-list');
            if (subscribersSection) {
                subscribersSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Initial setup for subscriber pagination
        attachPaginationListeners('subscribers-table-container', handleSubscriberPaginationClick);

        // Search input logic (unchanged)
        searchInput.addEventListener('input', function() {
            const query = this.value;
            fetchSubscribers(1, query);

            if (query.length > 0) {
                clearSearchBtn.classList.remove('hidden');
            } else {
                clearSearchBtn.classList.add('hidden');
            }
        });

        // Clear button logic (unchanged)
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            fetchSubscribers(1, '');
            clearSearchBtn.classList.add('hidden');
        });
        
        
        function handleJobAppPaginationClick(event) {
            // No AJAX implementation provided, but ensures the links behave correctly if the view handles 'job_app_page'
            let targetElement = event.target.closest('.page-link');
            if (!targetElement) return;
            // The browser will handle the navigation since it's a standard link (<a>)
        }
        
        // Attach listeners to the new Job App pagination links (if they exist)
        attachPaginationListeners('job-applications-table-container', handleJobAppPaginationClick);
    });
</script>
{% endblock %}